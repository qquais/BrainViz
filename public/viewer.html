<!DOCTYPE html>
<!--
  EEG Data Visualization Viewer - Enhanced Version
  
  This HTML file creates the full-screen EEG data visualization interface.
  Enhanced with IndexedDB storage support.
  
  Features:
  - Full viewport plotting area using Plotly.js
  - Interactive charts with zoom, pan, and hover capabilities
  - Responsive design that adapts to any screen size
  - Enhanced error handling with troubleshooting info
  - Support for both Chrome storage and IndexedDB
  
  Data Flow:
  1. Extension stores EEG data in Chrome storage OR IndexedDB (for large files)
  2. This page loads and retrieves data from appropriate storage
  3. viewer.js processes and visualizes the data using available decoders
  4. Plotly.js renders interactive charts
  
  Dependencies:
  - plotly.min.js (interactive charting library)
  - eegStorage.js (storage helper for IndexedDB)
  - viewer.js (data processing and visualization logic)
  - Chrome Extension APIs (storage, runtime)
  
  Version: 1.5 Enhanced Storage
  Author: EEG Reader Extension Team
-->
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>EEG Plot Viewer</title>

  <!-- 
    Plotly.js - Interactive charting library
    Used for creating interactive, zoomable EEG signal plots
    Features: zoom, pan, hover tooltips, responsive design
  -->
  <script src="libs/plotly.min.js"></script>

  <!--
    EEG Storage Helper - IndexedDB management
    Handles large file storage that exceeds Chrome storage limits
    Provides unified interface for both Chrome storage and IndexedDB
  -->
  <script src="eegStorage.js"></script>

  <!--
    Enhanced CSS for full-screen plotting experience
    Removes all margins and padding to maximize plot area
    Adds loading states and error styling
  -->
  <style>
    /* 
      Remove all default browser styling for clean full-screen experience
      Sets up the page for a complete plotting interface
    */
    body {
      margin: 0;
      /* Remove default browser margins */
      padding: 0;
      /* Remove default browser padding */
      font-family: Arial, sans-serif;
      /* Consistent font for any text elements */
      background: #f5f5f5;
      /* Light background for loading states */
    }

    /*
      Plot container takes up entire viewport
      This ensures the EEG visualization uses maximum screen real estate
    */
    #plot {
      width: 100vw;
      height: 50vh;
      /* Changed from 100vh to 50vh for stacked view */
      background: white;
    }

    #plot2 {
      width: 100vw;
      height: 50vh;
      /* New second plot for PSD */
      background: white;
      border-top: 1px solid #ddd;
    }

    /*
      Loading message styling
      Centers loading text and provides visual feedback
    */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-size: 18px;
      color: #666;
    }

    /*
      Error message container styling
      Provides clear error presentation with troubleshooting info
    */
    .error-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      flex-direction: column;
      padding: 20px;
      text-align: center;
    }

    .error-message {
      font-size: 18px;
      color: #d32f2f;
      margin-bottom: 20px;
      line-height: 1.4;
      max-width: 600px;
    }

    .troubleshooting {
      margin-bottom: 20px;
      padding: 15px;
      background: #f0f0f0;
      border-radius: 8px;
      font-size: 14px;
      max-width: 600px;
      text-align: left;
    }

    .technical-info {
      margin-bottom: 20px;
      padding: 15px;
      background: #e3f2fd;
      border-radius: 8px;
      font-size: 12px;
      max-width: 600px;
      text-align: left;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .btn-primary {
      background: #2196f3;
      color: white;
    }

    .btn-primary:hover {
      background: #1976d2;
    }

    .btn-success {
      background: #4caf50;
      color: white;
    }

    .btn-success:hover {
      background: #45a049;
    }

    /*
      Responsive design for smaller screens
      Ensures error messages remain readable on mobile devices
    */
    @media (max-width: 768px) {
      .error-container {
        padding: 10px;
      }

      .error-message,
      .troubleshooting,
      .technical-info {
        max-width: 90vw;
        font-size: smaller;
      }

      .action-buttons {
        flex-direction: column;
        width: 100%;
        max-width: 200px;
      }
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-btn {
      width: 100%;
      padding: 8px;
      background: #ffffff;
      border: 1px solid #ccc;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      min-width: 280px;
      z-index: 1000;
      white-space: nowrap;
    }
  </style>
</head>
<!--
    Main plot container
    This div will be replaced by either:
    - An interactive Plotly chart (success case)
    - A detailed error message with troubleshooting info (error case)
    - A loading message (initial state)
    
    The viewer.js script will determine which content to show based on:
    - Whether required libraries are loaded
    - Whether EEG data is available in storage
    - Whether the data can be successfully processed
  -->

<body style="
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      font-family: Arial, sans-serif;
    ">
  <!-- Control Bar -->
  <div style="
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        background: #f0f0f0;
        padding: 10px 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
      ">
    <label for="filterType" style="font-weight: bold">Filter:</label>
    <select id="filterType" style="padding: 4px">
      <option value="none">None</option>
      <option value="bandpass">Bandpass</option>
      <option value="highpass">High-pass</option>
      <option value="lowpass">Low-pass</option>
      <option value="notch">Notch</option>
    </select>
    <input type="number" id="lowFreq" placeholder="Low Freq" style="width: 80px" />
    <input type="number" id="highFreq" placeholder="High Freq" style="width: 80px" />
    <button id="applyFilter" class="btn btn-success">Apply Filter</button>

    <button id="psdButton" class="btn btn-primary">Show PSD</button>

    <label style="font-weight: bold">Channels:</label>
    <div class="dropdown" id="channelDropdown">
      <button class="dropdown-btn">Select Channels ⏷</button>
      <div class="dropdown-content" id="channelCheckboxes"></div>
    </div>

    <label for="windowSlider" style="font-weight: bold">Time Window:</label>
    <input type="range" id="windowSlider" min="0" max="100" step="1" value="0" style="width: 200px" />
    <span id="windowTimeLabel">0–10s</span>
  </div>
  </div>

  <div id="fileTitle" style="
        padding: 10px 15px;
        font-size: 16px;
        font-weight: bold;
        color: #333;
        background: #fafafa;
        border-bottom: 1px solid #ddd;
      ">
    <!-- filename will be injected here -->
  </div>

  <!-- Fullscreen Plot below the bar -->
  <div id="plot" style="
        position: absolute;
        top: 100px;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
      ">
    <!-- Plotly chart renders here -->
  </div>

  <div id="plot2" style="
      position: absolute;
      top: calc(50% + 100px);
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
    "></div>


  <!--
    Main visualization script
    Enhanced version that handles:
    - Multiple storage sources (Chrome storage + IndexedDB)
    - Multiple EDF decoder libraries (main + fallback)
    - Improved error handling and user feedback
    - Support for both text and binary EEG formats
    - Responsive design and performance optimization
  -->
  <script src="viewer.js"></script>
</body>

</html>